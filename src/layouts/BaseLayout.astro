---
import "../styles/global.css";

/**
 * SEO + Social defaults (multi-language).
 * Pass props from each page to customize metadata per route.
 */
const {
  title = "Vigarartattoo",
  description = "Tattoo studio in Málaga. Fine line, blackwork and custom designs.",
  canonical = "https://vigarartattoo.pages.dev/",
  ogImage = "/images/heroImg/rocio_001.jpeg",

  // i18n
  lang = "es",               // "es" | "en"
  alternateEs = "https://vigarartattoo.pages.dev/",
  alternateEn = "https://vigarartattoo.pages.dev/en/",
} = Astro.props;

const siteUrl = canonical?.endsWith("/") ? canonical.slice(0, -1) : canonical;
---
<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />

    <!-- ✅ hreflang alternates -->
    <link rel="alternate" href={alternateEs} hreflang="es" />
    <link rel="alternate" href={alternateEn} hreflang="en" />
    <link rel="alternate" href={alternateEs} hreflang="x-default" />

    <meta name="robots" content="index,follow" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={ogImage} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
  </head>


  <body class="min-h-screen bg-zinc-950 text-zinc-100">
    <slot />

    <!-- Local business structured data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "TattooParlor",
      "name": "Vigarartattoo",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Málaga",
        "addressCountry": "ES"
      },
      "url": siteUrl,
      "sameAs": [
        "https://www.instagram.com/vigarartattoo/"
      ]
    })} />

    <!-- Enable JS-only CSS rules -->
    <script>
      document.documentElement.classList.add("js");
    </script>

    <!-- Reveal sections -->
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        if (document.documentElement.dataset.vigarRevealInit === "true") return;
        document.documentElement.dataset.vigarRevealInit = "true";

        const elements = document.querySelectorAll(".reveal");

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              const el = entry.target;
              if (!(el instanceof HTMLElement)) return;

              requestAnimationFrame(() => {
                el.classList.toggle("reveal-visible", entry.isIntersecting);
              });
            });
          },
          { threshold: 0.12, rootMargin: "0px 0px -10% 0px" }
        );

        elements.forEach((el) => observer.observe(el));
      });
    </script>

    <!-- Stagger items -->
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        if (document.documentElement.dataset.vigarStaggerInit === "true") return;
        document.documentElement.dataset.vigarStaggerInit = "true";

        const items = Array.from(document.querySelectorAll(".reveal-item"));

        const obs = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              const el = entry.target;
              if (!(el instanceof HTMLElement)) return;

              if (entry.isIntersecting) {
                const siblings = Array.from(
                  el.parentElement?.querySelectorAll(".reveal-item") ?? []
                );
                const index = siblings.indexOf(el);
                el.style.transitionDelay = `${Math.min(index * 70, 500)}ms`;
                requestAnimationFrame(() => el.classList.add("is-in"));
              } else {
                el.style.transitionDelay = "0ms";
                requestAnimationFrame(() => el.classList.remove("is-in"));
              }
            });
          },
          { threshold: 0.12, rootMargin: "0px 0px -10% 0px" }
        );

        items.forEach((el) => obs.observe(el));
      });
    </script>

    <!-- Hero parallax -->
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const hero = document.querySelector("[data-parallax-hero]");
        if (!(hero instanceof HTMLElement)) return;

        if (hero.dataset.vigarParallaxInit === "true") return;
        hero.dataset.vigarParallaxInit = "true";

        const items = hero.querySelectorAll("[data-parallax]");
        let ticking = false;

        const update = () => {
          ticking = false;
          const rect = hero.getBoundingClientRect();
          const heroH = rect.height;
          const scrolledInHero = Math.min(Math.max(-rect.top, 0), heroH);

          items.forEach((el) => {
            if (!(el instanceof HTMLElement)) return;
            const speed = Number(el.dataset.speed ?? "0.2");
            const y = scrolledInHero * speed * 0.6;
            el.style.transform = `translate3d(0, ${y}px, 0)`;
          });
        };

        const onScroll = () => {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(update);
        };

        update();
        window.addEventListener("scroll", onScroll, { passive: true });
        window.addEventListener("resize", onScroll, { passive: true });
      });
    </script>

    <!-- Mobile menu -->
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const openBtn = document.querySelector("[data-menu-open]");
        const overlay = document.querySelector("[data-menu-overlay]");
        const closeBtns = document.querySelectorAll("[data-menu-close]");
        const links = document.querySelectorAll("[data-menu-link]");

        if (!(overlay instanceof HTMLElement) || !(openBtn instanceof HTMLElement)) return;
        if (overlay.dataset.vigarMenuInit === "true") return;
        overlay.dataset.vigarMenuInit = "true";

        const open = () => {
          overlay.classList.remove("hidden");
          overlay.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
          requestAnimationFrame(() => overlay.classList.add("is-open"));
        };

        const close = () => {
          overlay.classList.remove("is-open");
          overlay.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
          setTimeout(() => overlay.classList.add("hidden"), 220);
        };

        openBtn.addEventListener("click", open);
        closeBtns.forEach((b) => b.addEventListener("click", close));
        links.forEach((a) => a.addEventListener("click", close));

        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") close();
        });
      });
    </script>

    <!-- Sticky header -->
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const sticky = document.querySelector("[data-sticky-header]");
        if (!(sticky instanceof HTMLElement)) return;
        if (sticky.dataset.vigarStickyInit === "true") return;
        sticky.dataset.vigarStickyInit = "true";

        const showAfter = 260;
        let hideTimer: ReturnType<typeof setTimeout> | undefined;

        // ✅ Use the same attribute name everywhere
        const isLightboxOpen = () =>
          document.documentElement.dataset.lightboxOpen === "true";

        const show = () => {
          if (isLightboxOpen()) return;
          if (hideTimer) clearTimeout(hideTimer);
          sticky.classList.remove("hidden");
          requestAnimationFrame(() => sticky.classList.add("is-visible"));
        };

        const hide = () => {
          sticky.classList.remove("is-visible");
          hideTimer = setTimeout(() => sticky.classList.add("hidden"), 200);
        };

        const update = () => {
          const y = window.scrollY || document.documentElement.scrollTop;
          if (isLightboxOpen() || y <= showAfter) hide();
          else show();
        };

        update();
        window.addEventListener("scroll", update, { passive: true });

        // ✅ Observe the correct attribute: data-lightbox-open
        new MutationObserver(update).observe(document.documentElement, {
          attributes: true,
          attributeFilter: ["data-lightbox-open"],
        });
      });
    </script>

    <!-- Hide any UI marked with data-hide-on-lightbox -->
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        if (document.documentElement.dataset.vigarHideOnLightboxInit === "true") return;
        document.documentElement.dataset.vigarHideOnLightboxInit = "true";

        const update = () => {
          const open = document.documentElement.dataset.lightboxOpen === "true";
          document.querySelectorAll("[data-hide-on-lightbox]").forEach((el) => {
            if (!(el instanceof HTMLElement)) return;
            el.style.pointerEvents = open ? "none" : "";
            el.style.opacity = open ? "0" : "";
            el.style.transition = "opacity 160ms ease";
          });
        };

        update();

        new MutationObserver(update).observe(document.documentElement, {
          attributes: true,
          attributeFilter: ["data-lightbox-open"],
        });
      });
    </script>

    <!-- Scroll to top floating button -->
    <button
      type="button"
      class="fixed bottom-5 right-5 z-[70] hidden h-12 w-12 items-center justify-center rounded-full border border-white/15 bg-zinc-950/70 text-white shadow-lg shadow-black/30 backdrop-blur transition hover:bg-zinc-900/70 focus:outline-none focus:ring-2 focus:ring-white/30"
      data-scrolltop
      aria-label="Scroll to top"
      title="Scroll to top"
    >
      ↑
    </button>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const btn = document.querySelector("[data-scrolltop]");
        if (!(btn instanceof HTMLButtonElement)) return;

        if (btn.dataset.vigarInit === "true") return;
        btn.dataset.vigarInit = "true";

        const showAfter = 420;
        let ticking = false;

        const update = () => {
          ticking = false;

          const lightboxOpen = document.documentElement.dataset.lightboxOpen === "true";
          if (lightboxOpen) {
            btn.classList.add("hidden");
            return;
          }

          const y = window.scrollY || document.documentElement.scrollTop;
          btn.classList.toggle("hidden", y < showAfter);
        };

        const onScroll = () => {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(update);
        };

        btn.addEventListener("click", () => {
          window.scrollTo({ top: 0, behavior: "smooth" });
        });

        update();
        window.addEventListener("scroll", onScroll, { passive: true });

        new MutationObserver(update).observe(document.documentElement, {
          attributes: true,
          attributeFilter: ["data-lightbox-open"],
        });
      });
    </script>

    <!-- Active section highlight -->
    <script type="module">
      import { initActiveSectionHighlight } from "../scripts/activeSectionHighlight";
      window.addEventListener("DOMContentLoaded", initActiveSectionHighlight);
    </script>
  </body>
</html>
